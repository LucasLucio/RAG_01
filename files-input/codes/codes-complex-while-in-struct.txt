entry plCalculaDistanciaOferta
	params ;Parâmetros de entrada e saída 
		;Tipo parâmetro - NomeParâmetro - Definição de entrada ou saída
		struct p_stc_input     : IN
		struct p_stc_output    : OUT
	endparams
	variables
		numeric v_nr_pos, v_nr_latitude, v_nr_longitude, v_nr_latorigem, v_nr_lngorigem, v_qt_distancia
		struct  v_stc_oferta
	endvariables

	;Obtem valores de variáveis da struct
	v_nr_latorigem = p_stc_input->nr_latitude
	v_nr_lngorigem = p_stc_input->nr_longitude

	; Inicializa a resposta
	p_stc_output                   = $newstruct
	p_stc_output->$tags->jsonClass = "array" ;Define tipagem do nó para criação da struct

	;Posiciona primeiro registro da struct
	v_nr_pos     = 1
	v_stc_oferta = p_stc_input->ofertas->*{v_nr_pos}
	
	;Percorre membros do primeiro registro da struct
	while (v_stc_oferta->$membercount > 0)
 
		;Obtem dados da struct
		v_nr_latitude  = v_stc_oferta->motorista->localizacao->nr_latitude
		v_nr_longitude = v_stc_oferta->motorista->localizacao->nr_longitude		

		;Atribui dados a outro nó na struct
		v_stc_oferta->nr_latorigem = v_nr_latorigem
		v_stc_oferta->nr_lngorigem = v_nr_lngorigem
		v_stc_oferta->nr_latdestino = v_nr_latitude
		v_stc_oferta->nr_longitude  = v_nr_longitude

		;Verifica condicional de preenchimento das variáveis
		if (v_nr_latorigem & v_nr_lngorigem & v_nr_latitude & v_nr_longitude)
			
			;Chama operation em outro componente
			activate "CTRAO159".CALCULA_DISTANCIA (v_nr_latorigem, v_nr_lngorigem, v_nr_latitude, v_nr_longitude, v_qt_distancia, $t_ds_erro$)

			if ($status < 0);Validação de erros
				if ($status != <G_ERROEXEC>)
					call PL_ERRO_CMDMSG ($procerrorcontext)
				endif

				return (<G_ERROEXEC>)
			endif
		
			;Verificação de resultado obtido
			if (v_qt_distancia > 0)
				; Converte a distância de m para km
				v_stc_oferta->qt_distancia = v_qt_distancia / 1000
			endif
		endif
		
		;Atribui dado do retorno a struct
		p_stc_output->*{-1} = v_stc_oferta
	
		;Vai para o próximo registro
		v_nr_pos     = v_nr_pos + 1				
		v_stc_oferta = p_stc_input->ofertas->*{v_nr_pos}
	endwhile

	return (0) ;Retorno com sucesso
end

;Aninhamento de While
operation consultaSituacaoDivergencia
	params  ;Parâmetros de entrada e saída 
		;Tipo parâmetro - NomeParâmetro - Definição de entrada ou saída
		Numeric p_cd_transp        : in
		Numeric p_dt_anomes        : in
		Entity cndb_sitdiv.cndb    : out
		$t_ds_erro$        : out
	endParams
	variables
		Numeric v_nr_index, v_nr_size, v_nr_size_item, v_nr_index_item, v_nr_cota, v_nr_size_div, v_nr_index_div
		Date v_dt_inicio, v_dt_fim
		String v_ds_contexto, v_ls_param, v_ls_nr_cota, v_ls_hit_conc, v_ls_occ_conc, v_ls_hit_item_conc, v_ls_occ_item_conc, v_ls_hit_div, v_ls_occ_div
	endVariables

	;Inicialização de variáveis do tratamento de erros
	v_ds_contexto = "<$componentname>.consulta_sit_divergencia"
	
	;Limpa entidade para ser consultada
	clear/e "cndb_sitdiv"
	
	;Validação de dados obrigatórios
	if(p_cd_transp = "") 
		$t_ds_erro$ = "Código da transportadora é parâmetro obrigatório. (%%v_ds_contexto%%%)"
		return(<G_ERROEXEC>)
	elseif(p_dt_anomes = "")
		$t_ds_erro$ = "Ano/Mês é parâmetro obrigatório. (%%v_ds_contexto%%%)"
		return(<G_ERROEXEC>)
	endIf
	
	;Chama operation em outro componente
	activate "CTRAO243".DEFINE_PERIODO_ANOMES(p_cd_transp, p_dt_anomes, v_dt_inicio, v_dt_fim, $t_ds_erro$) 
	if($status < 0) ;Tratamento dos erros da chamada
		if($status != <G_ERROEXEC>)
			call PL_ERRO_CMDMSG($ProcErrorContext)
		endIf
		$t_ds_erro$ = "%%$t_ds_erro$%%% (%%v_ds_contexto%%%)"
		return(<G_ERROEXEC>)
	endIf
	
	;Chama operation em outro componente
	activate "CTRAO243".BUSCA_COTA_TRANSP(p_cd_transp, v_dt_inicio, v_dt_fim, v_ls_nr_cota, $t_ds_erro$)
	if($status < 0) ;Tratamento dos erros da chamada
		if($status != <G_ERROEXEC>)
			call PL_ERRO_CMDMSG($ProcErrorContext)
		endIf
		$t_ds_erro$ = "%%$t_ds_erro$%%% (%%v_ds_contexto%%%)"
		return(<G_ERROEXEC>)
	endIf
	
	;Contabiliza dados de lista
	v_nr_size = $ItemCount(v_ls_nr_cota)
	v_nr_index = 1 ; Inicializador do while
	while(v_nr_index <= v_nr_size)

		;Obtem dados da lista
		v_nr_cota = $ItemNr(v_nr_index, v_ls_nr_cota)
		
		;Cria registro na entidade
		creOcc "cndb_sitdiv", -1
		id_sitdiv.cndb_sitdiv = v_nr_index
		ds_sitcota.cndb_sitdiv = "Aberto" 
		nr_cota.cndb_sitdiv = v_nr_cota  
		qt_km.cndb_sitdiv = 0
		qt_divtotal.cndb_sitdiv = 0
		qt_divpend.cndb_sitdiv = 0
		qt_divconc.cndb_sitdiv = 0     
		
		;Atribui dados a lista para chamda de operação
		v_ls_hit_conc = ""
		v_ls_param = ""
		putItem/id v_ls_param, "cd_transp", p_cd_transp
		putItem/id v_ls_param, "dt_anomes", p_dt_anomes
		putItem/id v_ls_param, "nr_cota", nr_cota.cndb_sitdiv
		;Chama operation em outro componente
		activate "CTRAO243".BUSCA_CONCILIACAO(v_ls_param, v_ls_hit_conc, $t_ds_erro$)
		if($status < 0) ;Tratamento dos erros da chamada
			if($status != <G_ERROEXEC>)
				call PL_ERRO_CMDMSG($ProcErrorContext)
			endIf
			$t_ds_erro$ = "%%$t_ds_erro$%%% (%%v_ds_contexto%%%)"
			return(<G_ERROEXEC>)
		endIf
		v_ls_occ_conc = $ItemNr(1, v_ls_hit_conc)
		
		;Verifica retorno
		if(v_ls_occ_conc != "")
			
			;Prepara lista para chamada de operation em outro componente
			v_ls_hit_item_conc = ""
			v_ls_param = ""
			putItem/id v_ls_param, "id_concfrota", $Item("id_concfrota", v_ls_occ_conc)
			;Chama operation em outro componente
			activate "CTRAO243".BUSCA_ITEM_CONCILIACAO(v_ls_param, v_ls_hit_item_conc, $t_ds_erro$)
			if($status < 0) ;Tratamento dos erros da chamada
				if($status != <G_ERROEXEC>)
					call PL_ERRO_CMDMSG($ProcErrorContext)
				endIf
				$t_ds_erro$ = "%%$t_ds_erro$%%% (%%v_ds_contexto%%%)"
				return(<G_ERROEXEC>)
			endIf
			
			;Contabilida registros retornados
			v_nr_size_item = $ItemCount(v_ls_hit_item_conc)
			v_nr_index_item = 1
			
			;Define valores a serem atribuidos
			if(v_nr_size_item > 1)
				ds_sitcota.cndb_sitdiv = "Andamento"     
			endIf
			
			if($Item("dt_conclusao", v_ls_occ_conc) != "")
				ds_sitcota.cndb_sitdiv = "Concluído" 
			endIf
			
			;Segundo while para execução
			while(v_nr_size_item >= v_nr_index_item)
				v_ls_occ_item_conc = $ItemNr(v_nr_index_item, v_ls_hit_item_conc)
				
				;Prepara lista para chamada de operation em outro componente
				v_ls_hit_div = ""
				v_ls_param = ""
				putItem/id v_ls_param, "id_itemconc", $Item("id_itemconc", v_ls_occ_item_conc)
				;Chama operation em outro componente
				activate "CTRAO243".BUSCA_DIVERGENCIA(v_ls_param, v_ls_hit_div, $t_ds_erro$)
				if($status < 0);Tratamento dos erros da chamada
					if($status != <G_ERROEXEC>)
						call PL_ERRO_CMDMSG($ProcErrorContext)
					endIf
					$t_ds_erro$ = "%%$t_ds_erro$%%% (%%v_ds_contexto%%%)"
					return(<G_ERROEXEC>)
				endIf 
				
				;Validação dos dados
				if($Item("id_itemconc", v_ls_occ_item_conc) != "")
					qt_km.cndb_sitdiv += $Item("qt_kmpagar", v_ls_occ_item_conc)   
				endIf
				
				;Tratamento dos dados para chamda do terceiro while 
				v_nr_size_div = $ItemCount(v_ls_hit_div)
				v_nr_index_div = 1
				
				;Segundo while para execução
				while(v_nr_size_div >= v_nr_index_div)
					v_ls_occ_div = $ItemNr(v_nr_index_div, v_ls_hit_div)
					
					if($Item("dt_baixa", v_ls_occ_div) != "")
						qt_divconc.cndb_sitdiv += 1
					else
						qt_divpend.cndb_sitdiv += 1
					endIf
					
					qt_divtotal.cndb_sitdiv += 1
					
					v_nr_index_div += 1
				endwhile ;Fechamento terceiro while        
				
				v_nr_index_item += 1
			endWhile ;Fechamento segundo while        
		endIf
		
		v_nr_index += 1
	endWhile ;Fechamento primiero while        
				
	;Ordenação do retorno na entidade dos registros criados 
	sort "cndb_sitdiv", "nr_cota.cndb_sitdiv"
	
	return(0) ;Retorno com sucesso
end
